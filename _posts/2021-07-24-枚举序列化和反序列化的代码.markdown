---
layout: post
title: æšä¸¾åºåˆ—åŒ–å’Œååºåˆ—åŒ–çš„ä»£ç 
permalink: /æšä¸¾åºåˆ—åŒ–å’Œååºåˆ—åŒ–çš„ä»£ç 
date: 2021-07-24 20:20:00.000000000 +08:00
categories: [java,æšä¸¾]
tags: [å¼€å‘å·¥å…·ç±»,åºåˆ—åŒ–,ååºåˆ—åŒ–,æšä¸¾]
---

# å¿…é¡»ç”¨åˆ°çš„æšä¸¾å·¥å…·ç±»
* å‚è€ƒé€šç”¨æšä¸¾ [é€šç”¨æšä¸¾]({{ "/é€šç”¨æšä¸¾" | relative_url }})

# ä»£ç ï¼ˆæœ€åˆç‰ˆæœ¬ï¼‰

```java
public class EnumDeserializerConfig {
    
    /**
     * å¯ååºåˆ—åŒ–çš„æšä¸¾
     */
    public enum DeserializableEnum {
        // DBEnumç±»æ˜¯å•ç‹¬çš„ä¸€ä¸ªåŒ…ï¼Œä¹Ÿæ˜¯æšä¸¾çš„ä¸€ä¸ªé€šç”¨æ¥å£
        DB_Enum(DBEnum.class, DBEnum::getValue, IEnum::getDoc),
        // ä¸€ä¸ªæšä¸¾å¯¹åº”å•ä¸ªæ ‡è¯†
        I_Enum(IEnum.class, IEnum::getIdentity, IEnum::getDoc),
        // ä¸€ä¸ªæšä¸¾å¯¹åº”å¤šä¸ªæ ‡è¯†
        I_Enums(IEnums.class, IEnums::getIdentities, IEnums::getDoc),
        ;

        private final Class<?> serializableClass;
        private final Function<Object, Serializable> getIdentityFunction;
        private final Function<Object, String> getDocFunction;

        <T> DeserializableEnum(Class<T> serializableClass, Function<T, Serializable> getIdentityFunction, Function<T, String> getDocFunction) {
            this.serializableClass = serializableClass;
            this.getIdentityFunction = (Function<Object, Serializable>) getIdentityFunction;
            this.getDocFunction = (Function<Object, String>) getDocFunction;
        }

      /**
       * åˆ¤æ–­classæ˜¯å¦å¯ä»¥è¿›è¡Œååºåˆ—åŒ–
       */
        public static Optional<DeserializableEnum> getDeserializableEnum(Class<?> enumClass) {
            if (enumClass == null) {
                return Optional.empty();
            }
            if (!enumClass.isEnum()) {
                return Optional.empty();
            }
            for (DeserializableEnum deserializableEnum : DeserializableEnum.values()) {
                if (deserializableEnum.serializableClass.isAssignableFrom(enumClass)) {
                    return Optional.of(deserializableEnum);
                }
            }
            return Optional.empty();
        }

        /**
         * è¿›è¡Œååºåˆ—åŒ–
         */
        private Enum<?> deserializeEnum(Class<Enum<?>> enumClass, Object rawValue) {
            for (Enum<?> enumConstant : enumClass.getEnumConstants()) {
                Serializable identity = this.getGetIdentityFunction.apply(enumConstant);
                if (Objects.equals(identity, rawValue)) {
                    return enumConstant;
                }
                if (identity instanceof Object[]) {
                    for (Object i : (Object[]) identity) {
                        if (Objects.equals(i, rawValue)) {
                            return enumConstant;
                        }
                    }
                }
            }

            // æœ€åå€¼ä¸ºç©ºåˆ™è¿”å›null
            if (rawValue == null || StringUtils.isBlank(rawValue.toString())) {
                return null;
            }

            // è½¬æ¢å¤±è´¥ä¸€å¾‹æŠ›å¼‚å¸¸ï¼ŒåæœŸå¯æ ¹æ®æ³¨è§£è¿›è¡ŒåŠ¨æ€çš„æŠ›å¼‚å¸¸
            throw new EnumDeserializeException(MessageFormat.format("å‚æ•°é”™è¯¯ï¼Œæ— æ³•åŒ¹é…å¯¹åº”çš„ç±»å‹,value:{0}, type:{1}", rawValue, enumClass.getSimpleName()));
        }
    }

    /**
     * å®šä¹‰ä¸€ä¸ªå¸¸é‡ä¸ºspring converter ç»„ä»¶
     */
    public static final GenericConverter ENUM_DESERIALIZER_CONVERTER = new GenericConverter() {
        @Override
        public Set<ConvertiblePair> getConvertibleTypes() {
            Set<ConvertiblePair> cpSet = Sets.newHashSet();
            for (DeserializableEnum deserializableEnum : DeserializableEnum.values()) {
                /* convertåŒ¹é…é€»è¾‘ï¼š
                 å…ˆå¾ªç¯ sourceType æ°´å¹³class
                 ç„¶åå†…åµŒ targetType æ°´å¹³class è¿›è¡Œå†…åµŒå¾ªç¯
                 æ‰¾å¯¹å¯¹åº”çš„ConvertiblePairä¸ºæ­¢
                 æ‰€ä»¥sourceTypeå¿…é¡»æ¯”è¾ƒç²¾ç¡®ä¸ç„¶è¦†ç›–ä¸äº†defaultConvertor
                 */
                cpSet.add(new ConvertiblePair(String.class, deserializableEnum.serializableClass));
                cpSet.add(new ConvertiblePair(Number.class, deserializableEnum.serializableClass));
            }
            return cpSet;
        }

        @Override
        public Object convert(Object source, TypeDescriptor sourceType, TypeDescriptor targetType) {
            ResolvableType targetResolvableType = targetType.getResolvableType();
            Class<?> valueRawClass = getValueRawClass(targetResolvableType);
            if (valueRawClass == null) {
                return source;
            }
            Class<Enum<?>> enumClass = (Class<Enum<?>>) targetResolvableType.getRawClass();

            DeserializableEnum deserializableEnum = DeserializableEnum.getDeserializableEnum(enumClass).orElse(null);
            if (deserializableEnum == null) {
                return source;
            }
            // æŠŠsourceè½¬æ¢æˆæšä¸¾çœŸå®å€¼çš„ç±»å‹
            Object rawValue = DefaultConversionService.getSharedInstance().convert(source, valueRawClass);
            return deserializableEnum.deserializeEnum(enumClass, rawValue);
        }
    };

    /**
     * å®šä¹‰ä¸€ä¸ªå¸¸é‡ä¸ºjacksonModule ç»„ä»¶
     */
    public static final SimpleModule ENUM_MODULE = new SimpleModule() {
        @Override
        public void setupModule(SetupContext context) {

            // æ·»åŠ æšä¸¾ååºåˆ—åŒ–
            context.addDeserializers(new Deserializers.Base() {
                @Override
                public JsonDeserializer<?> findEnumDeserializer(Class<?> type, DeserializationConfig config, BeanDescription beanDesc) {
                    Class<?> valueRawClass = getValueRawClass(ResolvableType.forClass(type));
                    if (valueRawClass == null) {
                        return null;
                    }

                    return DeserializableEnum.getDeserializableEnum(type)
                            .map(deserializableEnum -> new JsonDeserializer<Enum<?>>() {
                                @Override
                                public Enum<?> deserialize(JsonParser jsonParser, DeserializationContext deserializationContext) throws IOException {
                                    Object value = DefaultConversionService.getSharedInstance().convert(jsonParser.getValueAsString(), valueRawClass);
                                    return deserializableEnum.deserializeEnum((Class<Enum<?>>) type, value);
                                }
                            }).orElse(null);

                }
            });
        }

    };


    /*
     * å®šä¹‰ä¸€ä¸ªå¸¸é‡ä¸ºfastJson ç»„ä»¶
     */
    public static final Module FASTJSON_MODULE = new Module() {
        @Override
        public ObjectDeserializer createDeserializer(ParserConfig config, Class type) {
            Class<?> valueRawClass = getValueRawClass(ResolvableType.forClass(type));
            if (valueRawClass == null) {
                return null;
            }

            return DeserializableEnum.getDeserializableEnum(type)
                    .map(deserializableEnum -> new ObjectDeserializer() {
                        @Override
                        public <T> T deserialze(DefaultJSONParser parser, Type type, Object fieldName) {
                            Object value = parser.parse();

                            Object rawValue = DefaultConversionService.getSharedInstance().convert(value, valueRawClass);
                            return (T) deserializableEnum.deserializeEnum((Class<Enum<?>>) type, rawValue);
                        }

                        public int getFastMatchToken() {
                            return JSONToken.LITERAL_STRING;
                        }
                    }).orElse(null);

        }

        @Override
        public ObjectSerializer createSerializer(SerializeConfig config, Class type) {
            return null;
        }
    };

    /**
     * è·å–æ¥å£ä¸Šçš„æ³›å‹
     */
    public static Class<?> getValueRawClass(ResolvableType realClassResolvedType) {
        ResolvableType[] enumInterfaces = realClassResolvedType.getInterfaces();
        if (ArrayUtils.isEmpty(enumInterfaces)) {
            return null;
        }
        ResolvableType valueResolvableType = enumInterfaces[0].getGeneric(0);
        if (valueResolvableType == ResolvableType.NONE) {
            return null;
        }
        return valueResolvableType.getRawClass();
    }


    public static class EnumDeserializeException extends RuntimeException {

        public EnumDeserializeException(String message) {
            super(message);
        }
    }

}
```

## ç¼ºé™·
1ï¼šç›®å‰ä¸æ”¯æŒåºåˆ—åŒ–ğŸ˜  
2ï¼šè·å–æšä¸¾identityç±»å‹çš„æ–¹æ³•æ¯”è¾ƒæ„šé’ï¼Œä¸€åˆ€åˆ‡äº†  
> å¦‚æœæ˜¯é—´æ¥å®ç°çš„æšä¸¾æˆ–è€…æ³›å‹çš„ä½ç½®ä¸åœ¨ç¬¬ä¸€ä¸ªä½ç½®ï¼Œé‚£å°±æœ‰é—®é¢˜å–½ã€‚  

3ï¼šååºåˆ—åŒ–å’Œåºåˆ—åŒ–åªèƒ½å•å±‚åºåˆ—å’Œååºåˆ—ï¼Œä»€ä¹ˆæ„æ€å‘¢ï¼Ÿ
> æšä¸¾çš„æ ‡è¯†å¯ä»¥åå‘æŸ¥æ‰¾æšä¸¾å¯¹å§ï¼Ÿå¦‚æœæšä¸¾çš„æ ‡è¯†è¿˜æ˜¯ä¸€ä¸ªæšä¸¾å‘¢ï¼Ÿç›®å‰åªæ”¯æŒåºåˆ—åŒ–å’Œååºåˆ—åŒ–æœ€å¤–ä¸€å±‚çš„valueã€‚å¤ªæŠ½è±¡ï¼Ÿ

* ç”¨æˆ·ç±»å‹1  
```java
public enum UserType1 implements IEnum<Integer> {

  NEW_USER(1, "æ–°ç”¨æˆ·"),

  OLD_USER(0, "è€ç”¨æˆ·");
  public final int code;

  public final String doc;

  UserType1(int code, String doc) {
    this.code = code;
    this.doc = doc;
  }

  @Override
  public Integer getIdentity() {
    return code;
  }
}
```

* ç”¨æˆ·ç±»å‹2  
```java
public enum UserType2 implements IEnum<UserType1> {

  NEW_USER(UserType1.NEW_USER, "æ–°ç”¨æˆ·2"),

  OLD_USER(UserType1.OLD_USER, "æ—§ç”¨æˆ·2");
  
  public final UserType1 userType1;

  public final String doc;

  UserType2(UserType1 userType1, String doc) {
    this.userType1 = userType1;
    this.doc = doc;
  }

  /**
   * å½“å‰æšä¸¾çš„æ ‡è¯†æ˜¯userType1æšä¸¾ç±»å‹
   */
  @Override
  public UserType1 getIdentity() {
    return userType1;
  }

  @Override
  public String getDoc() {
    return doc;
  }
}
```
å¦‚æœç”¨UserType2æšä¸¾çš„è¯ï¼Œååºåˆ—åŒ–æˆ–è€…åºåˆ—åŒ–å°±ä¼šå‡ºç°ç¼ºé™·ã€‚å› ä¸ºä¸æ”¯æŒå†…åµŒå¥—ä¸€ä¸ªæšä¸¾å½“åšå½“å‰æšä¸¾çš„æ ‡è¯†ã€‚  
æ‰€ä»¥æœ‰äº†ä»¥ä¸‹çš„æ–°ä»£ç ã€‚

# ä»£ç ï¼ˆæ–°ç‰ˆæœ¬ï¼‰
* æ”¯æŒåºåˆ—åŒ–å•¦
* æ”¯æŒæšä¸¾å†…åµŒçš„æ ‡è¯†åºåˆ—åŒ–å’Œååºåˆ—åŒ–
* æ›´ç²¾å‡†çš„è·å–æ³›å‹ä¸Šçš„æ ‡è¯†

```java
@Slf4j
public class EnumDeserializerConfig {


    /**
     * å¯ååºåˆ—åŒ–çš„æšä¸¾
     */
    public enum DeserializableEnum {
        DB_Enum(DBEnum.class, 0, DBEnum::getValue, DBEnum::getDoc),
        I_Enum(IEnum.class, 0, IEnum::getIdentity, IEnum::getDoc),
        I_Enums(IEnums.class, 0, IEnums::getIdentities, IEnums::getDoc),
        ;

        // å¯ååºåˆ—åŒ–æšä¸¾çš„æ¥å£
        public final Class<?> serializableClass;
        // æ¥å£å¯¹åº”çš„identity(æšä¸¾çš„æ ‡è¯†)æ³›å‹çš„ä¸‹æ ‡
        private final int identityGenericIndex;
        // è·å–æšä¸¾çš„identity
        private final Function<Enum<?>, Serializable> getIdentityFunction;
        // è·å–æšä¸¾çš„doc(æ–‡æ¡£)
        public final Function<Enum<?>, String> getDocFunction;

        <T> DeserializableEnum(Class<T> serializableClass, int identityGenericIndex, Function<T, Serializable> getIdentityFunction, Function<T, String> getDocFunction) {
            this.serializableClass = serializableClass;
            this.identityGenericIndex = identityGenericIndex;
            this.getIdentityFunction = (Function<Enum<?>, Serializable>) getIdentityFunction;
            this.getDocFunction = (Function<Enum<?>, String>) getDocFunction;
        }

        /**
         * è¿›è¡Œååºåˆ—åŒ–
         */
        private Enum<?> deserializeEnum(Class<Enum<?>> enumClass, Object rawValue) {
            for (Enum<?> enumConstant : enumClass.getEnumConstants()) {
                Object identity = getIdentity(enumConstant);
                if (identity instanceof Object[]) {
                    for (Object i : (Object[]) identity) {
                        if (Objects.equals(i, rawValue)) {
                            return enumConstant;
                        }
                    }
                } else {
                    if (Objects.equals(identity, rawValue)) {
                        return enumConstant;
                    }
                }
            }

            // æœ€åå€¼ä¸ºç©ºåˆ™è¿”å›null
            if (rawValue == null || StringUtils.isBlank(rawValue.toString())) {
                return null;
            }

            // è½¬æ¢å¤±è´¥ä¸€å¾‹æŠ›å¼‚å¸¸ï¼ŒåæœŸå¯æ ¹æ®æ³¨è§£è¿›è¡ŒåŠ¨æ€çš„æŠ›å¼‚å¸¸
            throw new EnumDeserializeException(MessageFormat.format("å‚æ•°é”™è¯¯ï¼Œæ— æ³•åŒ¹é…å¯¹åº”çš„ç±»å‹,value:{0}, type:{1}", rawValue, enumClass.getSimpleName()));
        }
        
        public Object getIdentity(Enum<?> enumConstant) {
            Serializable identity = this.getIdentityFunction.apply(enumConstant);
            if (identity == null) {
                return null;
            }
            Class<?> identityType;
            if (identity instanceof Object[]) {
                identityType = identity.getClass().getComponentType();
            } else {
                identityType = identity.getClass();
            }

            // é€’å½’åˆ¤æ–­
            DeserializableEnum deserializableEnum = getDeserializableEnumAndIdentityClass(identityType)
                    .map(Map.Entry::getKey)
                    .orElse(null);

            if (deserializableEnum == null || !(identity instanceof Enum<?>)) {
                return identity;
            }
            return deserializableEnum.getIdentity((Enum<?>) identity);
        }

        /**
         * è·å–æ¥å£ä¸Šæ ‡è¯†æšä¸¾å€¼çš„ç±»å‹
         */
        private Class<?> getValueRawClass(Class<?> serializableClass) {
            ResolvableType resolvableType = ResolvableType.forClass(serializableClass).as(this.serializableClass);
            Class<?> valueRawClass = resolvableType.getGeneric(this.identityGenericIndex).resolve();
            // åˆ¤æ–­é€’å½’è·å–
            DeserializableEnum deserializableEnum = DeserializableEnum.getDeserializableEnumAndIdentityClass(valueRawClass)
                    .map(Map.Entry::getKey)
                    .orElse(null);

            if (deserializableEnum == null) {
                return valueRawClass;
            }

            return deserializableEnum.getValueRawClass(valueRawClass);
        }

        public static Optional<Map.Entry<DeserializableEnum, Class<?>>> getDeserializableEnumAndIdentityClass(Class<?> enumClass) {
            if (enumClass == null) {
                return Optional.empty();
            }
            if (!enumClass.isEnum()) {
                return Optional.empty();
            }
            for (DeserializableEnum deserializableEnum : DeserializableEnum.values()) {
                if (deserializableEnum.serializableClass.isAssignableFrom(enumClass)) {
                    Class<?> identityValueRawClass = deserializableEnum.getValueRawClass(enumClass);
                    return Optional.of(Pair.of(deserializableEnum, identityValueRawClass));
                }
            }
            return Optional.empty();
        }
    }

    /**
     * spring converterååºåˆ—åŒ–
     */
    public static final GenericConverter ENUM_DESERIALIZER_CONVERTER = new GenericConverter() {
        @Override
        public Set<ConvertiblePair> getConvertibleTypes() {
            Set<ConvertiblePair> cpSet = Sets.newHashSet();
            for (DeserializableEnum deserializableEnum : DeserializableEnum.values()) {
                /* åŒ¹é…é€»è¾‘ï¼š
                 å…ˆå¾ªç¯ sourceType æ°´å¹³class
                 ç„¶åå†…åµŒ targetType æ°´å¹³class è¿›è¡Œå†…åµŒå¾ªç¯
                 æ‰¾å¯¹å¯¹åº”çš„ConvertiblePairä¸ºæ­¢
                 æ‰€ä»¥sourceTypeå¿…é¡»æ¯”è¾ƒç²¾ç¡®ä¸ç„¶è¦†ç›–ä¸äº†defaultConvertor
                 */
                cpSet.add(new ConvertiblePair(String.class, deserializableEnum.serializableClass));
                cpSet.add(new ConvertiblePair(Number.class, deserializableEnum.serializableClass));
            }
            return cpSet;
        }

        @Override
        public Object convert(Object source, TypeDescriptor sourceType, TypeDescriptor targetType) {
            Class<?> targetClass = targetType.getResolvableType().getRawClass();

            return DeserializableEnum.getDeserializableEnumAndIdentityClass(targetClass)
                    .map((Function<Map.Entry<DeserializableEnum, Class<?>>, Object>) entry -> {
                        Object rawValue = DefaultConversionService.getSharedInstance().convert(source, entry.getValue());
                        return entry.getKey().deserializeEnum((Class<Enum<?>>) targetClass, rawValue);
                    }).orElse(null);
        }
    };

    /**
     * jacksonModuleåºåˆ—åŒ–å’Œååºåˆ—åŒ–
     */
    public static final SimpleModule ENUM_MODULE = new SimpleModule() {
        @Override
        public void setupModule(SetupContext context) {
            context.addSerializers(new Serializers.Base() {
                @Override
                public JsonSerializer<?> findSerializer(SerializationConfig config, JavaType type, BeanDescription beanDesc) {
                    return DeserializableEnum.getDeserializableEnumAndIdentityClass(type.getRawClass())
                            .map(Map.Entry::getKey)
                            .map(deserializableEnum -> new JsonSerializer<Enum<?>>() {
                                @Override
                                public void serialize(Enum<?> o, JsonGenerator jsonGenerator, SerializerProvider serializerProvider) throws IOException {
                                    jsonGenerator.writeObject(deserializableEnum.getIdentity(o));
                                }
                            }).orElse(null);
                }
            });

            context.addDeserializers(new Deserializers.Base() {
                @Override
                public JsonDeserializer<?> findEnumDeserializer(Class<?> type, DeserializationConfig config, BeanDescription beanDesc) {
                    return DeserializableEnum.getDeserializableEnumAndIdentityClass(type)
                            .map(entry -> new JsonDeserializer<Enum<?>>() {
                                public Enum<?> deserialize(JsonParser jsonParser, DeserializationContext deserializationContext) throws IOException {
                                    Object value = DefaultConversionService.getSharedInstance().convert(jsonParser.getValueAsString(), entry.getValue());
                                    return entry.getKey().deserializeEnum((Class<Enum<?>>) type, value);
                                }
                            }).orElse(null);
                }
            });
        }

    };


    /*
     * fastJson æšä¸¾åºåˆ—åŒ–å’Œååºåˆ—åŒ–
     */
    public static final Module FASTJSON_MODULE = new Module() {
        @Override
        public ObjectDeserializer createDeserializer(ParserConfig config, Class type) {
            return DeserializableEnum.getDeserializableEnumAndIdentityClass(type)
                    .map(entry -> new ObjectDeserializer() {
                        @Override
                        public <T> T deserialze(DefaultJSONParser parser, Type type, Object fieldName) {
                            Object rawValue = DefaultConversionService.getSharedInstance().convert(parser.parse(), entry.getValue());
                            return (T) entry.getKey().deserializeEnum((Class<Enum<?>>) type, rawValue);
                        }

                        @Override
                        public int getFastMatchToken() {
                            return JSONToken.LITERAL_STRING;
                        }
                    }).orElse(null);
        }

        @Override
        public ObjectSerializer createSerializer(SerializeConfig config, Class type) {
            return DeserializableEnum.getDeserializableEnumAndIdentityClass(type)
                    .map(entry -> new ObjectSerializer() {
                        @Override
                        public void write(JSONSerializer serializer, Object object, Object fieldName, Type fieldType, int features) {
                            serializer.write(entry.getKey().getIdentity((Enum<?>) object));
                        }
                    }).orElse(null);
        }
    };


    public static class EnumDeserializeException extends RuntimeException {

        public EnumDeserializeException(String message) {
            super(message);
        }
    }

}
```